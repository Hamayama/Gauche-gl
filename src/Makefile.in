#
# Makefile.in for Gauche-gl/src
#  $Id: Makefile.in,v 1.28 2003-10-10 02:19:46 shirok Exp $
#

# prelude ---------------------------------------------

.SUFFIXES: .stub

.stub.c :
	$(GOSH) genstub $<

SHELL       = @SHELL@
srcdir      = @srcdir@
VPATH       = $(srcdir)
top_builddir = @top_builddir@
top_srcdir   = @top_srcdir@

# These may be overridden by make invocators
DESTDIR  = 
OPTFLAGS = @OPTFLAGS@

# These are set by configure
# NB: cc and various flags must match the ones used to compile Gauche,
# so the make invocator shouldn't casually override them.
CC       = @CC@
CFLAGS   = @DEFS@ @CFLAGS@ @X_CFLAGS@ @GLUT_INCDIR@ $(OPTFLAGS)
LDFLAGS  = @LDFLAGS@
OBJEXT   = @OBJEXT@
SOEXT    = @SOEXT@
OLIBS    = @LIBS@
LIBS     = @GL_LIBS@ @LIBS@ @X_LIBS@ @X_PRE_LIBS@ @X_EXTRA_LIBS@ @X_LIBS@ 
INSTALL  = @INSTALL@
GOSH     = @GOSH@
GAUCHE_CONFIG = @GAUCHE_CONFIG@
MKINSTDIR = $(top_srcdir)/mkinstalldirs

INSTALL_TYPE = @INSTALL_TYPE@
HEADER_INSTALL_DIR  = $(DESTDIR)`$(GAUCHE_CONFIG) --$(INSTALL_TYPE)incdir`
SCM_INSTALL_DIR     = $(DESTDIR)`$(GAUCHE_CONFIG) --$(INSTALL_TYPE)libdir`
ARCH_INSTALL_DIR    = $(DESTDIR)`$(GAUCHE_CONFIG) --$(INSTALL_TYPE)archdir`

# build -----------------------------------------------

ARCHFILES = libgauche-math3d.$(SOEXT) \
            libgauche-gl.$(SOEXT) \
            libgauche-glut.$(SOEXT)
SCMFILES = 
HEADERS = gauche/math3d.h

TARGET = $(ARCHFILES)
GLOBJS = gl_head.$(OBJEXT) gauche-gl.$(OBJEXT) gl-lib.$(OBJEXT) \
         gl-syms.$(OBJEXT) glu-lib.$(OBJEXT) gl_tail.$(OBJEXT)
GLUTOBJS = glut_head.$(OBJEXT) gauche-glut.$(OBJEXT) \
           glut-lib.$(OBJEXT) glut_tail.$(OBJEXT)
MATHOBJS = math3d_head.$(OBJEXT) gauche-math3d.$(OBJEXT) \
           math3d-lib.$(OBJEXT) math3d_tail.$(OBJEXT)
OBJS = $(GLOBJS) $(GLUTOBJS) $(MATHOBJS)
CONFIG_GENERATED = Makefile config.cache config.log config.status \
                   gl_head.c gl_tail.c glut_head.c glut_tail.c \
		   math3d_head.c math3d_tail.c
GENERATED = gl-lib.c gl-syms.c glu-lib.c glut-lib.c \
            math3d-lib.c gettype-sizes.c 

all : $(TARGET)

libgauche-math3d.$(SOEXT) : $(MATHOBJS)
	$(CC) $(LDFLAGS) libgauche-math3d.$(SOEXT) $(MATHOBJS) $(OLIBS)

libgauche-math3d.$(OBJEXT) : gauche/math3d.h

libgauche-gl.$(SOEXT) : $(GLOBJS)
	$(CC) $(LDFLAGS) libgauche-gl.$(SOEXT) $(GLOBJS) @GL_EXTRALIBS@ $(LIBS)

math3d-lib.c : math3d-lib.stub
gl-lib.c : gl-lib.stub
gl-syms.c : gl-syms.stub
glu-lib.c : glu-lib.stub
gauche-gl.c : gettype-sizes.c

gettype-sizes.c : glstate.scm
	$(GOSH) ./glstate.scm -o gettype-sizes.c gettype

$(GLOBJS) : gauche-gl.h gauche/math3d.h

libgauche-glut.$(SOEXT) : $(GLUTOBJS)
	$(CC) $(LDFLAGS) libgauche-glut.$(SOEXT) $(GLUTOBJS) @GLUT_LIBDIR@ @GLUT_LIB@ @GLUT_EXTRALIBS@ $(LIBS)

glut-lib.c : glut-lib.stub

$(GLUTOBJS) : gauche-glut.h

# tests -----------------------------------------------

check : all
	@rm -f test.log
	$(GOSH) -I. -I../lib test-math3d.scm > test.log
	$(GOSH) -I. -I../lib test.scm >> test.log

# install ----------------------------------------------

INSTALL_DIRS = $(HEADER_INSTALL_DIR)/gauche \
               $(SCM_INSTALL_DIR) \
               $(ARCH_INSTALL_DIR)

install : all
	$(MKINSTDIR) $(INSTALL_DIRS)
	@for f in $(HEADERS) _end; do \
	  if test $$f != _end; then \
	    $(INSTALL) -m 444 $$f $(HEADER_INSTALL_DIR)/$$f; \
	  fi; \
	done
	@for f in $(SCMFILES) _end; do \
	  if test $$f != _end; then \
	    $(INSTALL) -m 444 $$f $(SCM_INSTALL_DIR); \
	  fi; \
	done
	@for f in $(ARCHFILES) _end; do \
	  if test $$f != _end; then \
	    $(INSTALL) -m 555 $$f $(ARCH_INSTALL_DIR); \
	  fi; \
	done

# clean ------------------------------------------------

clean :
	rm -rf core $(TARGET) $(OBJS) $(GENERATED) *~ test.log so_locations

distclean : clean
	rm -rf $(CONFIG_GENERATED)

maintainer-clean : clean
	rm -rf $(CONFIG_GENERATED) configure
